# 扎金花 AI 统一规则手册

本手册用于指导项目内所有 AI 对手的设计、实现与验证，保证不同难度、不同模块的 AI 行为一致、可维护、可扩展。所有开发与调优工作必须遵循以下规范。

## 1. 总体目标
- 提供与真人对局风格相似的体验，兼顾公平性与挑战性。  
- 允许通过参数化配置快速生成不同个性与难度的 AI。  
- 保证 AI 决策可解释、可回放、可调试。

## 2. 决策流程
1. **收集信息**：读取当前手牌、牌型评估值、筹码、底池、回合数、已看牌状态、历史下注记录以及玩家情绪指标。  
2. **评估形势**：计算当前胜率估计、风险值（风险 = 当前下注需求 / 剩余筹码）与桌面压力（对手平均筹码差）。  
3. **策略选择**：根据难度档位、AI 个性标签（稳健/激进/平衡）、局势评分生成动作期望列表。  
4. **执行动作**：在允许的动作集内选取最终动作（跟注/加注/弃牌/看牌/比牌）。  
5. **记录结果**：将本轮决策输入日志，供调试或学习模块使用。

## 3. 难度设定基线
| 难度 | 胜率评估精度 | 诈唬权重 | 风险承受度 | 调整说明 |
| ---- | ------------ | -------- | ---------- | -------- |
| 简单 | 使用粗粒度牌型评分（6 档），忽略对手历史 | 低（<5%），仅在高牌力时偶尔小加注 | 低，筹码<50% 时倾向保守 | 适合新手，动作延迟较长 |
| 普通 | 使用概率估计（牌型枚举 + Monte Carlo 采样 200 次） | 中（10%），结合对手弃牌率调整 | 中，允许在胜率>55% 时主动进攻 | 默认难度，节奏贴合真实玩家 |
| 困难 | 使用高精度估算（动态采样 500-1000 次 + 历史建模） | 中高（15%-20%），策略性混合诈唬 | 高，根据对手筹码弱点主动施压 | 动作节奏更快但需保持合理性 |

> 难度差异主要通过评估函数精度、风险偏好、诈唬频率和响应延迟呈现，不通过“作弊”型知识（如直接读取对手手牌）。

## 4. 动作策略规范
- **跟注**：当胜率估计 ≥ 跟注阈值（默认 45%）或筹码过多且底池价值高。  
- **加注**：满足胜率 ≥ 加注阈值（默认 55%）或进行策略性诈唬；加注倍率需限定在当前允许范围并参考筹码占比。  
- **弃牌**：胜率 < 弃牌阈值（默认 35%）且风险系数高，或连续被加注超过容忍次数。  
- **看牌**：在允许回合后，如果筹码紧张但胜率不明朗，应优先看牌再决策；困难难度可延迟看牌以制造压力。  
- **比牌**：仅在胜率估计明显领先（>65%）或对手频繁诈唬且筹码充足时使用，比较前需确认消耗筹码不会导致危险处境。

## 5. 情绪与个性模型
- 每个 AI 实例包含 **稳定性**（0-1）、**进攻性**（0-1）、**智谋值**（0-1）三个关键参数：  
  - 稳定性越高，越不易受短期波动影响。  
  - 进攻性越高，加注阈值越低、诈唬概率越高。  
  - 智谋值越高，决策更依赖长期统计，低则依赖简单规则。  
- 可选 **标签**：谨慎型、稳健型、激进型、随机型。标签通过调整上述参数与日志消息文案反映个性。  
- 情绪值基于结果波动（赢/输、连续加注）动态更新，对应轻微调整动作概率，但需保持可控。

## 6. 随机性与公平性
- 所有随机决策必须使用统一的随机源并支持设定种子（便于回放和测试）。  
- 禁止读取任何未公开信息（例如其他玩家手牌、洗牌顺序），难度差异仅通过策略模型实现。  
- 若算法依赖 Monte Carlo 模拟，需限制时间预算并在超时前返回最优已知方案。

## 7. 日志与调试
- 日志记录遵循中文输出格式：`[AI][玩家名][回合] 动作信息`。  
- 每次决策至少记录：输入特征、胜率估计、阈值、最终动作、预期收益。  
- 在开发环境可开启详细日志与决策追踪，在生产环境默认关闭，仅保留关键事件。  
- 日志接口需与 Riverpod 状态管理分离，避免影响 UI 性能。

## 8. 代码结构要求
- AI 逻辑放置于 `lib/modules/game/ai/`（建议结构），核心算法封装为纯 Dart 服务。  
- 提供接口 `AiPolicy` / `AiDecisionEngine`：  
  - `evaluate(GameState state) -> AiDecision` 返回动作与附加参数。  
  - 允许注入不同策略实现（工厂模式或依赖注入）。  
- 策略参数存放于 `data` 层的配置文件或常量，支持热更新（开发环境）与远程配置（未来扩展）。  
- 代码注释全部使用中文，说明公式、阈值来源、可调参数意义。

## 9. 测试规范
- **单元测试**：覆盖胜率估算、动作阈值计算、随机策略分布等核心函数。  
- **策略回放测试**：使用固定种子模拟完整牌局，验证日志与决策符合预期。  
- **难度差异验证**：通过统计结果（胜率、平均下注次数）核对各难度档位是否达到目标区间。  
- **性能测试**：确保决策计算在 16ms 之内完成，避免卡顿；必要时将耗时操作移至 Isolate。

## 10. 版本管理与调优流程
- 所有策略更新必须通过配置版本号或代码提交说明标注改动原因与影响。  
- 引入新难度/个性前需完成 P0 用例测试与回放验证。  
- 针对 AI 行为异常（如频繁自杀式加注）需提供复现记录与日志，修复后补充测试覆盖。  
- 重要参数（阈值、权重）调整需记录在文档附录或配置说明中，确保团队可追踪。

## 附录
- **命名约束**：难度枚举建议命名为 `AiDifficulty.easy | normal | hard`；策略类统一后缀 `Policy`。  
- **数据接口**：对接游戏引擎时仅通过公开的只读状态模型获取信息，避免直接引用 UI 层数据结构。  
- **占位接口**：提前预留联网对战、机器学习模块的扩展点，但在当前阶段保持禁用状态。

---

请在迭代前确认 AI 策略是否符合本规范，如需新增条目或调整规则，必须先更新本手册并经团队确认后执行。***
